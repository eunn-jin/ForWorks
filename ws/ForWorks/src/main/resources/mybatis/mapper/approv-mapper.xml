<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="approvMapper">

	<select id="selectApprovList" resultType="ApprovDocumentVo">
		SELECT 
			A.ADOC_NO,
			A.ADOC_NAME,
			A.ADOC_CONTENT,
			A.EMP_NO,
			A.DRAFT_DATE,
			A.NOELEC_STATUS,
			D.EMP_NAME
		FROM (SELECT
        MIN(DOCAPPROVE.APPROVE_NO) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) APPROVE_NO,
        MIN(DOCAPPROVE.ADOC_NO) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) ADOC_NO,
        MIN(DOCAPPROVE.APPROVE_STATUS) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) APPROVE_STATUS,
        MIN(DOCAPPROVE.APPROVE_DATE) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) APPROVE_DATE,
        MIN(DOCAPPROVE.EMP_NO) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) EMP_NO,
        MIN(EMPLOYEE.EMP_NAME) KEEP(DENSE_RANK FIRST ORDER BY EMPLOYEE.POS_NO DESC) EMP_NAME
        FROM DOCAPPROVE 
        LEFT JOIN EMPLOYEE
        ON DOCAPPROVE.EMP_NO = EMPLOYEE.EMP_NO
        WHERE 
        APPROVE_STATUS = 'N'
        AND
        APPROVE_STATUS != 'R'
        GROUP BY ADOC_NO) D
		LEFT JOIN APPROVEDOCUMENT A
        ON A.ADOC_NO = D.ADOC_NO
		WHERE
		D.EMP_NO = #{empNo}
	</select>
	
	<select id="selectCoopList" resultType="ApprovDocumentVo">
		SELECT 
			A.ADOC_NO,
			A.ADOC_NAME,
			A.ADOC_CONTENT,
			A.EMP_NO,
            E.EMP_NAME,
			A.DRAFT_DATE,
			A.NOELEC_STATUS
		FROM APPROVEDOCUMENT A
		RIGHT JOIN DOCCOOP D
			ON A.ADOC_NO = D.ADOC_NO
        JOIN EMPLOYEE E
         ON A.EMP_NO = E.EMP_NO
		WHERE
        D.EMP_NO = #{empNo}
	</select>
	
	<select id="selectReferList" resultType="ApprovDocumentVo">
		SELECT 
			A.ADOC_NO,
			A.ADOC_NAME,
			A.ADOC_CONTENT,
			A.EMP_NO,
			E.EMP_NAME,
			A.DRAFT_DATE,
			A.NOELEC_STATUS
		FROM APPROVEDOCUMENT A
		RIGHT JOIN DOCREFER D
			ON A.ADOC_NO = D.ADOC_NO
		JOIN EMPLOYEE E
         ON A.EMP_NO = E.EMP_NO
		WHERE
		D.EMP_NO = #{empNo}
	</select>
	
	<select id="selectRejectApprovList" resultType="ApprovDocumentVo">
		SELECT 
			A.ADOC_NO,
			A.ADOC_NAME,
			A.ADOC_CONTENT,
			A.EMP_NO,
			E.EMP_NAME,
			A.DRAFT_DATE,
			A.NOELEC_STATUS
		FROM APPROVEDOCUMENT A
		RIGHT JOIN DOCAPPROVE D
			ON A.ADOC_NO = D.ADOC_NO
		JOIN EMPLOYEE E
         ON A.EMP_NO = E.EMP_NO
		WHERE
		A.EMP_NO = #{empNo}
		AND
		APPROVE_STATUS = 'R'
	</select>
	
	<select id="selectMemberList" resultType="MemberVo">
		SELECT 
			E.EMP_NO
			, E.EMP_NAME
			, D.DEPT_NAME
			, P.POS_NAME
		FROM EMPLOYEE E
		LEFT JOIN DEPARTMENT D
			ON E.DEPT_NO = D.DEPT_NO
		LEFT JOIN POSITION P
			ON E.POS_NO = P.POS_NO
	</select>
	
	<insert id="insertApprovDoc">
		INSERT INTO APPROVEDOCUMENT
		(
			ADOC_NO,
			ADOC_NAME,
			ADOC_CONTENT,
			EMP_NO,
			DRAFT_DATE
		)
		VALUES
		(
			SEQ_APPROVEDOCUMENT_NO.nextval,
			#{adocName},
			#{adocContent},
			#{empNo},
			SYSDATE
		)
	</insert>
	
	<select id="selectDocNoOneByContent" resultType="int">
		SELECT
			ADOC_NO
		FROM
		APPROVEDOCUMENT
		WHERE
		ADOC_CONTENT = #{adocContent}
	</select>
	
	<insert id="insertDocApprove">
		<foreach collection="approvMember" item="x" open="declare begin" close="; end;" separator=";">
		INSERT INTO DOCAPPROVE
		(
			APPROVE_NO,
			ADOC_NO,
			EMP_NO
		)
		VALUES
		(
			SEQ_DOCAPPROVE_NO.nextval,
			SEQ_APPROVEDOCUMENT_NO.CURRVAL,
			#{x}
		)
		</foreach>
	</insert>
	
	<insert id="insertDocCoop">
		<foreach collection="coopMember" item="x" open="declare begin" close="; end;" separator=";">
		INSERT INTO DOCCOOP
		(
			COOP_NO,
			ADOC_NO,
			EMP_NO
		)
		VALUES
		(
			SEQ_DOCCOOP_NO.nextval,
			SEQ_APPROVEDOCUMENT_NO.CURRVAL,
			#{x}
		)
		</foreach>
	</insert>
	
	<insert id="insertDocRefer">
		<foreach collection="referMember" item="x" open="declare begin" close="; end;" separator=";">
		INSERT INTO DOCREFER
		(
			REFER_NO,
			ADOC_NO,
			EMP_NO
		)
		VALUES
		(
			SEQ_DOCREFER_NO.nextval,
			SEQ_APPROVEDOCUMENT_NO.CURRVAL,
			#{x}
		)
		</foreach>
	</insert>
	
	<insert id="insertDocFile">
		INSERT INTO DOCFILE
		(
			DOCFILE_NO,
			ADOC_NO,
			DOCFILE_ORIGIN,
			DOCFILE_EDIT
		)
		VALUES
		(
			SEQ_DOCFILE_NO.nextval,
			#{adocNo},
			#{fileName},
			#{changeFileName}
		)	
	</insert>
	
	<insert id="insertNoElecApprovDoc">
		INSERT INTO APPROVEDOCUMENT
		(
			ADOC_NO,
			ADOC_NAME,
			ADOC_CONTENT,
			EMP_NO,
			DRAFT_DATE
		)
		VALUES
		(
			SEQ_APPROVEDOCUMENT_NO.nextval,
			#{adocName},
			'비전자문서',
			#{empNo},
			SYSDATE
		)
	</insert>
	
	<insert id="insertNoElecDoc">
		INSERT INTO NOELECDOC
		(
			NOELEC_NO,
			ADOC_NO,
			NOELEC_ORIGIN_NAME,
			NOELEC_CHANGE_NAME
		)
		VALUES
		(
			SEQ_NOELECDOC_NO.nextval,
			SEQ_APPROVEDOCUMENT_NO.currval,
			#{fileName},
			#{changeFileName}
		)
	</insert>
	
	<update id="updateDocApprov">
		UPDATE DOCAPPROVE
		SET
		APPROVE_STATUS = #{approveStatus}
		WHERE
		ADOC_NO = #{adocNo}
		AND
		EMP_NO = #{empNo}
	</update>
	
	
	<insert id="insertSignFile">
		INSERT INTO SIGNFILE
		(
			SIGN_NO,
			EMP_NO,
			SIGN_ORIGIN,
			SIGN_EDIT
		)
		VALUES
		(
			SEQ_SIGNFILE_NO.NEXTVAL,
			#{empNo},
			#{signOrigin},
			#{signEdit}
		)
	</insert>
	
	<select id="selectSignOne" resultType="DocSignVo">
		SELECT
			SIGN_NO,
			EMP_NO,
			SIGN_ORIGIN,
			SIGN_EDIT
		FROM
		SIGNFILE
		WHERE
		EMP_NO = #{empNo} 
	</select>
	
	<update id="updateSignOne">
		UPDATE SIGNFILE
		SET
		SIGN_ORIGIN = #{signOrigin},
		SIGN_EDIT = #{signEdit} 
		WHERE
		EMP_NO = #{empNo} 
	</update>
	
	<select id="selectApprovDocEmpNo" resultType="int">
		SELECT
			APPROVE_NO,
			ADOC_NO,
			APPROVE_STATUS,
			APPROVE_DATE,
			EMP_NO
		FROM
		DOCAPPROVE
		WHERE
		EMP_NO = ${empNo}
		AND
		ADOC_NO = ${adocNo}
	</select>
	
	<select id="selectApprovDocOneByNo" resultType="ApprovDocumentVo">
		SELECT
            AD.ADOC_NO,
            AD.ADOC_NAME,
            AD.ADOC_CONTENT,
            AD.EMP_NO,
            E.EMP_NAME,
            AD.DRAFT_DATE,
            AD.NOELEC_STATUS
        FROM APPROVEDOCUMENT AD
        JOIN EMPLOYEE E
        ON A.EMP_NO = E.EMP_NO
	</select>
	
</mapper>
